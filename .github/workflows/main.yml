name: Deploy

on:
  push:
    branches:
      - main

env:
  SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
  PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
  PUBLIC_ENVIRONMENT: ${{ secrets.PUBLIC_ENVIRONMENT }}
  PRISMA_DATABASE_URL: ${{ secrets.PRISMA_DATABASE_URL }}
  JWK_FOR_SIGN_IN_PUBLIC: ${{ secrets.JWK_FOR_SIGN_IN_PUBLIC }}
  JWK_FOR_SIGN_IN_PRIVATE: ${{ secrets.JWK_FOR_SIGN_IN_PRIVATE }}
  JWK_FOR_ACCESS_TOKEN_PUBLIC: ${{ secrets.JWK_FOR_ACCESS_TOKEN_PUBLIC }}
  JWK_FOR_ACCESS_TOKEN_PRIVATE: ${{ secrets.JWK_FOR_ACCESS_TOKEN_PRIVATE }}
  JWK_FOR_REFRESH_TOKEN_PUBLIC: ${{ secrets.JWK_FOR_REFRESH_TOKEN_PUBLIC }}
  JWK_FOR_REFRESH_TOKEN_PRIVATE: ${{ secrets.JWK_FOR_REFRESH_TOKEN_PRIVATE }}
  CLOUDFLARE_TURNSTILE_PRIVATE_KEY: ${{ secrets.CLOUDFLARE_TURNSTILE_PRIVATE_KEY }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - uses: actions/checkout@v2
      - name: Publish
        uses: cloudflare/wrangler-action@2.0.0
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          preCommands: npm i && npm run prisma-to-cloud && npm run build
